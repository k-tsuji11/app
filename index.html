<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Leveler - Quest Analyze</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; --gold: #d97706; --success: #059669;
            --danger: #dc2626; --bg: #f8fafc; --card: #ffffff;
            --text-main: #1e293b;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg); color: var(--text-main); 
            margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; 
        }

        .game-layout { 
            display: grid; grid-template-columns: 320px 1fr; gap: 20px; 
            max-width: 1100px; width: 100%; 
        }

        .panel { 
            background: var(--card); padding: 20px; border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        }

        .hidden { display: none !important; }

        h2 { font-size: 0.9rem; margin: 0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }

        .field { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 4px; }
        input { 
            width: 100%; background: #f1f5f9; border: 2px solid #e2e8f0; 
            border-radius: 8px; padding: 8px; color: var(--text-main); box-sizing: border-box;
        }

        .total-display { font-size: 2.2rem; font-weight: 800; text-align: center; margin: 15px 0; color: var(--primary); }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day-cell { 
            background: #fff; border: 1px solid #e2e8f0; aspect-ratio: 1/1; 
            border-radius: 8px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; position: relative; min-height: 60px;
        }
        .day-cell:hover { background: #f1f5f9; }
        .day-cell.active { background: #ecfdf5; border-color: var(--success); }
        .day-num { font-size: 0.7rem; position: absolute; top: 4px; left: 6px; color: #94a3b8; }
        .work-time { font-size: 0.85rem; font-weight: bold; color: var(--success); }

        /* ãƒœã‚¿ãƒ³ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-analyze { background: var(--gold); color: white; }
        .btn-back { background: var(--primary); color: white; }
        
        /* çµ±è¨ˆç”»é¢ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
        .chart-container { position: relative; height: 180px; width: 100%; margin-top: 10px; }
        
        @media (max-width: 800px) { .game-layout { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="main-view" class="game-layout">
    <div class="panel">
        <h2>PLAYER STATS</h2>
        <div class="field"><label>æ™‚çµ¦ (WAGE)</label><input type="number" id="wage" value="1200"></div>
        <div class="field"><label>ç›®æ¨™é¡ (GOAL)</label><input type="number" id="target" value="200000"></div>
        
        <div class="total-display"><span id="net">0</span><span style="font-size: 0.9rem;"> å††</span></div>
        
        <div id="advice-text" style="font-size: 0.8rem; text-align:center; color: #64748b; margin-bottom: 10px; min-height: 1.2em;"></div>
        
        <button id="to-stats-btn" class="btn btn-analyze">ANALYZE (åˆ†æãƒ¢ãƒ¼ãƒ‰) ğŸ“Š</button>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="border-color: var(--success); margin-bottom: 0;">QUEST LOG (2026å¹´1æœˆ)</h2>
            <div style="font-weight: bold; color: var(--success); font-size: 0.9rem;">Total: <span id="cal-total-h">0</span>h</div>
        </div>
        <div class="calendar-grid" id="calendar-body"></div>
    </div>
</div>

<div id="stats-view" class="panel hidden" style="max-width: 850px; width: 95%;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">MISSION ANALYSIS</h2>
        <button id="to-main-btn" class="btn btn-back" style="width: auto; margin: 0; padding: 8px 20px;">æˆ»ã‚‹</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <label>ã‚¯ã‚¨ã‚¹ãƒˆé”æˆç‡</label>
            <div class="chart-container"><canvas id="goalChart"></canvas></div>
        </div>
        <div class="stat-card">
            <label>æ›œæ—¥åˆ¥ãƒ»åŠ´åƒåˆè¨ˆ(h)</label>
            <div class="chart-container"><canvas id="dayChart"></canvas></div>
        </div>
        <div class="stat-card">
            <label>å¹³å‡å‹¤å‹™ / æ¨å®šæ”¯çµ¦é¡</label>
            <div id="avg-h" style="font-size: 1.8rem; font-weight: bold; color: var(--primary); margin-top: 15px;">0 h/æ—¥</div>
            <div id="gross-amount" style="font-weight: bold; color: var(--success); margin-top: 5px;">0 å††</div>
        </div>
        <div class="stat-card">
            <label>ã‚¯ã‚¨ã‚¹ãƒˆå‚¾å‘åˆ†æ</label>
            <div id="ai-insight" style="font-size: 0.8rem; color: #475569; margin-top: 15px; line-height: 1.5; text-align: left; padding: 0 10px;">
                ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>
    </div>
</div>

<script type="py">
import json
import datetime
from pyscript import window, document
from pyodide.ffi import create_proxy

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿
work_log = {}
goal_chart = None
day_chart = None

def save_data():
    """ãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜"""
    data = {
        "wage": document.getElementById("wage").value,
        "target": document.getElementById("target").value,
        "log": work_log
    }
    window.localStorage.setItem("money_leveler_vFinal", json.dumps(data))

def load_data():
    """ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿"""
    global work_log
    raw = window.localStorage.getItem("money_leveler_vFinal")
    if raw:
        try:
            data = json.loads(raw)
            document.getElementById("wage").value = data.get("wage", 1200)
            document.getElementById("target").value = data.get("target", 200000)
            work_log = data.get("log", {})
        except: pass

def update_ui():
    """ãƒ¡ã‚¤ãƒ³ç”»é¢ã®æ•°å€¤æ›´æ–°"""
    wage = float(document.getElementById("wage").value or 0)
    target = float(document.getElementById("target").value or 0)
    total_h = sum(float(v) for v in work_log.values())
    
    document.getElementById("cal-total-h").innerText = f"{total_h:.1f}"
    net = int((wage * total_h) * 0.8)
    document.getElementById("net").innerText = f"{net:,}"
    
    diff = target - net
    adv = document.getElementById("advice-text")
    if diff > 0:
        adv.innerHTML = f"ç›®æ¨™ã¾ã§ã‚ã¨ <b style='color:var(--danger)'>{diff:,}å††</b>"
    else:
        adv.innerHTML = "<b style='color:var(--success)'>MISSION COMPLETE!</b>"
    save_data()

def render_charts(event=None):
    """ã‚°ãƒ©ãƒ•ã®æç”» (JavaScriptã®Chart.jsã‚’ä½¿ç”¨)"""
    global goal_chart, day_chart
    
    wage = float(document.getElementById("wage").value or 0)
    target = float(document.getElementById("target").value or 1)
    total_h = sum(float(v) for v in work_log.values())
    net = int((wage * total_h) * 0.8)
    
    # æ›œæ—¥åˆ¥é›†è¨ˆ (2026å¹´1æœˆãƒ™ãƒ¼ã‚¹)
    day_totals = [0.0] * 7
    weekday_names = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"]
    for d_str, h in work_log.items():
        dt = datetime.date(2026, 1, int(d_str))
        day_totals[dt.weekday()] += float(h)

    # JSå´ã«æ¸¡ã™ãŸã‚ã®ãƒ—ãƒ­ã‚­ã‚·ä½œæˆ
    js_goal_labels = window.Array.from_(create_proxy(["æ‰‹å–ã‚Š", "ä¸è¶³"]))
    js_goal_data = window.Array.from_(create_proxy([net, max(0, target - net)]))
    
    js_day_labels = window.Array.from_(create_proxy(weekday_names))
    js_day_data = window.Array.from_(create_proxy(day_totals))

    # ã‚¯ã‚¨ã‚¹ãƒˆé”æˆç‡ã‚°ãƒ©ãƒ•
    if goal_chart: goal_chart.destroy()
    goal_ctx = document.getElementById("goalChart")
    goal_chart = window.Chart.new(goal_ctx, create_proxy({
        "type": "doughnut",
        "data": {
            "labels": js_goal_labels,
            "datasets": [{"data": js_goal_data, "backgroundColor": ["#4f46e5", "#e2e8f0"]}]
        },
        "options": {"maintainAspectRatio": False}
    }))

    # æ›œæ—¥åˆ¥æ£’ã‚°ãƒ©ãƒ•
    if day_chart: day_chart.destroy()
    day_ctx = document.getElementById("dayChart")
    day_chart = window.Chart.new(day_ctx, create_proxy({
        "type": "bar",
        "data": {
            "labels": js_day_labels,
            "datasets": [{"label": "h", "data": js_day_data, "backgroundColor": "#059669"}]
        },
        "options": {
            "maintainAspectRatio": False,
            "plugins": {"legend": {"display": False}},
            "scales": {"y": {"beginAtZero": True}}
        }
    }))

    # å¹³å‡ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    days_worked = len([v for v in work_log.values() if float(v) > 0])
    avg_h = total_h / days_worked if days_worked > 0 else 0
    document.getElementById("avg-h").innerText = f"{avg_h:.1f} h/æ—¥"
    document.getElementById("gross-amount").innerText = f"æ”¯çµ¦é¡: {int(wage * total_h):,} å††"
    
    max_h = max(day_totals)
    if max_h > 0:
        best_day = weekday_names[day_totals.index(max_h)]
        document.getElementById("ai-insight").innerHTML = f"ç¾åœ¨ã®ç¨¼ãæ™‚ã¯<b>{best_day}æ›œæ—¥</b>ã§ã™ã€‚<br>ã“ã®èª¿å­ã§å¹³å‡{avg_h:.1f}æ™‚é–“ã‚’ç¶­æŒã™ã‚Œã°ã€åŠ¹ç‡çš„ã«ç›®æ¨™ã¸è¿‘ã¥ã‘ã¾ã™ï¼"

def switch_view(show_stats):
    """ç”»é¢åˆ‡ã‚Šæ›¿ãˆ"""
    if show_stats:
        document.getElementById("main-view").classList.add("hidden")
        document.getElementById("stats-view").classList.remove("hidden")
        # ç¢ºå®Ÿã«è¦ç´ ãŒè¡¨ç¤ºã•ã‚Œã¦ã‹ã‚‰æç”»
        window.setTimeout(create_proxy(render_charts), 100)
    else:
        document.getElementById("stats-view").classList.add("hidden")
        document.getElementById("main-view").classList.remove("hidden")

def on_day_click(event):
    """ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚"""
    day = event.currentTarget.getAttribute("data-day")
    current = work_log.get(day, "")
    val = window.prompt(f"2026/1/{day} ã®å‹¤å‹™æ™‚é–“(h)ã‚’å…¥åŠ›:", str(current))
    
    if val is not None:
        try:
            if val == "" or float(val) == 0:
                if day in work_log: del work_log[day]
                event.currentTarget.classList.remove("active")
                event.currentTarget.querySelector(".work-time").innerText = ""
            else:
                work_log[day] = float(val)
                event.currentTarget.classList.add("active")
                event.currentTarget.querySelector(".work-time").innerText = f"{val}h"
            update_ui()
        except: pass

# ---------------------------------------------------------
# åˆæœŸåŒ–å‡¦ç†
# ---------------------------------------------------------
load_data()

# ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
grid = document.getElementById("calendar-body")
for d in range(1, 32):
    cell = document.createElement("div")
    cell.className = "day-cell"
    if str(d) in work_log: cell.classList.add("active")
    cell.setAttribute("data-day", str(d))
    
    num = document.createElement("span")
    num.className = "day-num"
    num.innerText = str(d)
    
    time_s = document.createElement("span")
    time_s.className = "work-time"
    time_s.innerText = f"{work_log[str(d)]}h" if str(d) in work_log else ""
    
    cell.appendChild(num)
    cell.appendChild(time_s)
    cell.addEventListener("click", create_proxy(on_day_click))
    grid.appendChild(cell)

update_ui()

# ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
document.getElementById("to-stats-btn").onclick = lambda e: switch_view(True)
document.getElementById("to-main-btn").onclick = lambda e: switch_view(False)
document.getElementById("wage").oninput = lambda e: update_ui()
document.getElementById("target").oninput = lambda e: update_ui()
</script>

</body>
</html>