<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Leveler - Persistent Quest Log</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; --gold: #d97706; --success: #059669;
            --danger: #dc2626; --bg: #f8fafc; --card: #ffffff;
            --text-main: #1e293b;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg); color: var(--text-main); 
            margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; 
        }

        .game-layout { 
            display: grid; grid-template-columns: 320px 1fr; gap: 20px; 
            max-width: 1100px; width: 100%; 
        }

        .panel { 
            background: var(--card); padding: 20px; border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
        }

        h2 { font-size: 0.9rem; margin-top: 0; border-left: 4px solid var(--primary); padding-left: 10px; }

        .field { margin-bottom: 12px; }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 4px; }
        input { 
            width: 100%; background: #f1f5f9; border: 2px solid #e2e8f0; 
            border-radius: 8px; padding: 8px; color: var(--text-main); box-sizing: border-box;
        }

        .total-display { font-size: 2.2rem; font-weight: 800; text-align: center; margin: 15px 0; color: var(--primary); }

        .quest-status {
            background: #f8fafc; border: 2px dashed #cbd5e1; padding: 12px; border-radius: 12px;
        }
        .remain-amount { font-size: 1.4rem; font-weight: bold; color: var(--danger); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day-cell { 
            background: #fff; border: 1px solid #e2e8f0; aspect-ratio: 1/1; 
            border-radius: 8px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; position: relative;
        }
        .day-cell:hover { background: #f1f5f9; border-color: var(--primary); }
        .day-cell.active { background: #ecfdf5; border-color: var(--success); }
        .day-num { font-size: 0.7rem; position: absolute; top: 4px; left: 6px; color: #94a3b8; }
        .work-time { font-size: 0.85rem; font-weight: bold; color: var(--success); }

        .save-indicator {
            font-size: 0.7rem; color: var(--success); text-align: center; margin-top: 10px;
            opacity: 0; transition: opacity 0.5s;
        }

        @media (max-width: 800px) { .game-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="game-layout">
    <div class="panel">
        <h2>PLAYER STATS</h2>
        <div class="field"><label>時給 (WAGE)</label><input type="number" id="wage" value="1200"></div>
        <div class="field"><label>目標額 (GOAL)</label><input type="number" id="target" value="200000"></div>
        <div class="field"><label>合計時間</label><input type="text" id="hours" readonly style="background:#e2e8f0"></div>
        
        <div class="total-display"><span id="net">0</span><span style="font-size: 0.9rem;"> 円</span></div>
        
        <div class="quest-status">
            <div style="font-size: 0.75rem;">あと...</div>
            <div class="remain-amount" id="diff-amount">0 円</div>
            <div id="advice-text" style="font-size: 0.75rem; color: #64748b;"></div>
        </div>
        
        <div id="save-msg" class="save-indicator">✓ クエストデータをセーブしました</div>
    </div>

    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="border-color: var(--success);">QUEST LOG</h2>
            <div style="font-weight: bold; color: var(--success);">Total: <span id="cal-total-h">0</span>h</div>
        </div>
        <div class="calendar-grid" id="calendar-body"></div>
    </div>
</div>

<script type="py">
import json
from pyscript import window, document
from pyodide.ffi import create_proxy

# 記録用データ
work_log = {}

def save_data():
    """ブラウザのLocalStorageに保存"""
    data = {
        "wage": document.getElementById("wage").value,
        "target": document.getElementById("target").value,
        "log": work_log
    }
    window.localStorage.setItem("money_leveler_data", json.dumps(data))
    
    # セーブ完了表示
    msg = document.getElementById("save-msg")
    msg.style.opacity = "1"
    def hide_msg(): msg.style.opacity = "0"
    window.setTimeout(create_proxy(hide_msg), 2000)

def load_data():
    """ブラウザからデータを復元"""
    global work_log
    raw_data = window.localStorage.getItem("money_leveler_data")
    if raw_data:
        try:
            data = json.loads(raw_data)
            document.getElementById("wage").value = data.get("wage", 1200)
            document.getElementById("target").value = data.get("target", 200000)
            work_log = data.get("log", {})
            return True
        except:
            return False
    return False

def update_ui(event=None):
    wage = float(document.getElementById("wage").value or 0)
    target = float(document.getElementById("target").value or 0)
    total_h = sum(float(v) for v in work_log.values())
    
    # 表示更新
    document.getElementById("hours").value = f"{total_h:.1f} h"
    document.getElementById("cal-total-h").innerText = f"{total_h:.1f}"
    
    net = int((wage * total_h) * 0.8)
    document.getElementById("net").innerText = f"{net:,}"
    
    diff = target - net
    diff_el = document.getElementById("diff-amount")
    adv_el = document.getElementById("advice-text")
    
    if diff <= 0:
        diff_el.innerText = "QUEST CLEAR!"
        diff_el.style.color = "var(--success)"
        adv_el.innerText = "目標達成！お疲れ様です！"
    else:
        diff_el.innerText = f"{diff:,} 円"
        diff_el.style.color = "var(--danger)"
        need_h = (diff / 0.8) / wage if wage > 0 else 0
        adv_el.innerHTML = f"あと約 <b>{need_h:.1f} 時間</b> の出撃"
    
    save_data()

def on_day_click(event):
    day = event.currentTarget.getAttribute("data-day")
    current = work_log.get(day, "")
    val = window.prompt(f"{day}日の勤務時間(h)を入力:", str(current))
    
    if val is not None:
        try:
            if val == "" or float(val) == 0:
                if day in work_log: del work_log[day]
                event.currentTarget.classList.remove("active")
                event.currentTarget.querySelector(".work-time").innerText = ""
            else:
                work_log[day] = float(val)
                event.currentTarget.classList.add("active")
                event.currentTarget.querySelector(".work-time").innerText = f"{val}h"
            update_ui()
        except:
            pass

def init():
    # データ読み込み
    load_data()
    
    # カレンダー生成
    grid = document.getElementById("calendar-body")
    for d in range(1, 32):
        cell = document.createElement("div")
        cell.className = "day-cell"
        cell.setAttribute("data-day", str(d))
        
        num = document.createElement("span")
        num.className = "day-num"
        num.innerText = str(d)
        
        time_disp = document.createElement("span")
        time_disp.className = "work-time"
        
        # 復元データがあれば表示
        if str(d) in work_log:
            cell.classList.add("active")
            time_disp.innerText = f"{work_log[str(d)]}h"
            
        cell.appendChild(num)
        cell.appendChild(time_disp)
        cell.addEventListener("click", create_proxy(on_day_click))
        grid.appendChild(cell)
    
    # 初期計算
    update_ui()
    
    # 入力変更時も保存
    document.getElementById("wage").addEventListener("input", create_proxy(update_ui))
    document.getElementById("target").addEventListener("input", create_proxy(update_ui))

init()
</script>

</body>
</html>S